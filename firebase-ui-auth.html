<link rel="import" href="../polymer/polymer.html">
<script src="https://www.gstatic.com/firebasejs/ui/live/1.0/firebase-ui-auth.js"></script>
<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/live/1.0/firebase-ui-auth.css" />
  <!--
    `<firebase-ui-auth></firebase-ui-auth>` HTML wrapper for firebase-ui-auth.js
    @demo demo.html
  -->
<dom-module id="firebase-ui-auth">
  <template>
    <div id="firebaseui-auth-container"></div>
    <template is="dom-if" if="[[user]]">
      <template is="dom-if" if="[[!user.photoURL]]">
        <image-base64 url="[[user.providerData.0.photoURL]]" width="[[widthPhoto]]" base64="{{user.photoUrl}}"></image-base64>
      </template>
   </template>
  </template>
</dom-module>
<script>
  Polymer({
    is: "firebase-ui-auth",
    properties:{
      user:{
        notify:true,
      },
      widthPhoto:{
        value: 75
      },
      signInSuccessUrl:{
        value: "/"
      },
      signIn :{
        value:[
          "GoogleAuthProvider",
          "FacebookAuthProvider",
          "TwitterAuthProvider",
          "GithubAuthProvider",
          "EmailAuthProvider"
        ],
        type: Array
      },
      tosUrl:{
        value: "/"
      },
      ui: {
        notify:true,
        computed: "getUi(signInSuccessUrl,signInOptions,tosUrl)"
      }
    },
    ready: function(){
      var that = this
      var trys = 0 
      firebase.auth().onAuthStateChanged(function(user) {
        that.signInOptions = that.signIn.map(function(signInProvider) {
          if ( firebase.auth.hasOwnProperty(signInProvider) ) {
            return firebase.auth[signInProvider].PROVIDER_ID
          }
        })
        var providerData = user.providerData
        var displayName = user.displayName || user.providerData[0].displayName
        var email = user.email
        var emailVerified = user.emailVerified
        var photoURL = user.photoURL
        var uid = user.uid || user.providerData[0].uid
        
        user.getToken().then(function(accessToken) {
          that.user = {
            displayName: displayName,
            primaryName: email,
            email: email,
            emailVerified: emailVerified,
            photoURL: photoURL,
            uid: uid,
            accessToken: accessToken,
            providerData: providerData,
           }
         });
        that.user = user
      }, function(error) {
        console.log(error)
      })
    },
    getUi: function(signInSuccessUrl,signInOptions,tosUrl){
      var getAbsoluteUrl = (function() {
        var a
        return function(url) {
          if (!a) {
            a = document.createElement('a')
          }
          a.href = url
          return a.href
        };
      })();
      var uiConfig = {
        signInSuccessUrl: getAbsoluteUrl(signInSuccessUrl),
        signInOptions: signInOptions,
        tosUrl: getAbsoluteUrl(tosUrl),
      }
      var ui = new firebaseui.auth.AuthUI(firebase.auth())
      ui.start(this.$["firebaseui-auth-container"], uiConfig)
      return ui
    },
    signOut: function() {
      firebase.auth().signOut()
      this.user = null
    },
  })
</script>
